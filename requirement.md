# ğŸ“¦ Prompt for AI Agent â€” â€œBuild Purgo.js: the Zero-Config PHI-Scrubber (Single-Package Edition)â€

You are an expert JavaScript infrastructure engineer with experience shipping npm libraries that serve **millions of weekly downloads**.  
Your focus is HIPAA & security-compliance tooling that is ruthlessly small and fast.

## ğŸ¯ Objective  
Design and implement **Purgo.js**, a ***single-package***, client-side log-scrubbing library that prevents Protected Health Information (PHI) from leaking into browser consoles, DevTools, and network debuggers.

### Non-negotiables  
1. **Pure JavaScript / TypeScript** â€“ *no WebAssembly, no native addons.*  
2. One npm package (`purgo`) â€” **not a monorepo**.  
3. Works out-of-the-box in **React, Next 14, Vue 3, vanilla JS** with **zero config**.  
4. Adds **< 3 % runtime overhead** and weighs **< 7 kB gzip** (browser build).  
5. Patches `console.*`, `window.fetch`, and `XMLHttpRequest` synchronously; no PHI leaves the tab raw.  
6. Exposes an optional Node helper **in the same package** via sub-path export (`import 'purgo/node'`).  
7. Ships MIT license **plus** a ready-to-sign Business Associate Agreement (BAA) template in `/legal`.

---

## ğŸ“‘ Deliverables

* `src/` â€” TypeScript source (browser + node adapters).  
* `dist/` â€” ESBuild output: ESM (`.mjs`) & CJS (`.cjs`).  
* `index.d.ts` & sub-path typings (`node.d.ts`).  
* `README.md` â€” copy-paste snippets for React, Next API Route, Vue plugin, `<script>` tag, Node.  
* `CHANGELOG.md` â€” Conventional Commits.  
* `tests/` â€” Vitest unit & integration tests (100 % coverage).  
* `perf/benchmark.js` â€” compares Purgo vs raw `console.log` & Pino redaction.  
* GitHub Actions: type-check, tests, `size-limit` (< 7 kB gzip), `npm publish --dry-run`.

---

## ğŸ“ Product Requirements (PRD)

### 1 Features
| ID | Title | Description |
|----|-------|-------------|
| F-1 | Zero-Config Bootstrap | `import 'purgo'` auto-patches targets in any runtime. |
| F-2 | Pluggable Patterns | Built-in PHI regex pack (email, phone, SSN, MRN, ICD-10). Users can add regex or `(val) => string` replacers. |
| F-3 | Deep Object Scrub | Recursively masks values in arrays & objects while preserving shape. |
| F-4 | Hash Mode | Optional SHA-256 hashing of censored tokens for correlation. |
| F-5 | Safe Helper | `purgo.redact(value)` returns a redacted clone. |
| F-6 | Node Adapter | `import 'purgo/node'` wraps `process.stdout` and exports `pinoRedactor()` helper. |

### 2 Non-Functional  
* **Performance:** â‰¤ 40 Âµs to redact a 5 kB string on M1 2.8 GHz.  
* **Bundle Size:** â‰¤ 7 kB gzip (`size-limit` enforced).  
* **Security:** No `eval` / `new Function`; patterns compiled once at start-up.  
* **Compatibility:** Evergreen browsers + Node LTS.

### 3 Out of Scope  
* Audit-PDF generation (server concern).  
* Any WebAssembly.

---

## ğŸ›  Architecture (Single Package)

purgo/ â”œâ”€ src/ â”‚ â”œâ”€ browser.ts // console, fetch, XHR patches â”‚ â”œâ”€ node.ts // stdout & Pino helper â”‚ â”œâ”€ redact.ts // engine (fast-redact + trie) â”‚ â””â”€ index.ts // entry re-exports + side-effects â”œâ”€ dist/ // generated by ESBuild â”œâ”€ tests/ â”œâ”€ legal/BAA-template.md â””â”€ package.json (exports map: ".", "./node", "./redact")



---

## ğŸ’» Public API (TypeScript)

```ts
// Zero-config bootstrap
import 'purgo';

// Custom bootstrap
import { purgo } from 'purgo';
purgo({
  targets: ['console','fetch','xhr'],
  patterns: ['email','ssn', /\b\d{7,8}-[A-Z]{2}\b/],
  censor: (m) => '[***]' + m.slice(-2)
});

// Helper
import { redact } from 'purgo';
const clean = redact({ mrn:'1234567', name:'Alice' });

// Node adapter (same package)
import 'purgo/node';              // auto-wrap process.stdout
import { pinoRedactor } from 'purgo/node';
```

---
ğŸ”¬ Example Integrations
Next 14 Root Layout
```ts
// app/layout.tsx
import 'purgo';
export default function Layout({ children }) {
  return <html><body>{children}</body></html>;
}
```

Vue 3

```ts
import 'purgo';
createApp(App).mount('#app');
```

Node + Pino

```js
import 'purgo/node';
import pino from 'pino';
const log = pino({ redact: pinoRedactor({ paths:['req.body'] }) });
```


ğŸ§ª Test Plan
Unit: redact scalar, nested, circular refs.
Integration: patch console & fetch, assert DevTools clone scrubs.
Perf: bench.js vs baseline.
Size: npm run size-limit.

